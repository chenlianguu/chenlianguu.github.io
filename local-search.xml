<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Dockeréƒ¨ç½²Nextcloud</title>
    <link href="/2020/01/09/Docker%E9%83%A8%E7%BD%B2Nextcloud/"/>
    <url>/2020/01/09/Docker%E9%83%A8%E7%BD%B2Nextcloud/</url>
    
    <content type="html"><![CDATA[<h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><h3 id="dockerçš„å®‰è£…åŠé…ç½®"><a href="#dockerçš„å®‰è£…åŠé…ç½®" class="headerlink" title="dockerçš„å®‰è£…åŠé…ç½®"></a>dockerçš„å®‰è£…åŠé…ç½®</h3><pre><code class="shell"># é€šè¿‡yumå®‰è£…yum install -y docker-ce# å¯åŠ¨dockerå¹¶è®¾ç½®å¼€æœºå¯åŠ¨systemctl start dockersystemctl enable docker# aws ec2 linux2å¦å¤–ä¸€ç§å®‰è£…æ–¹å¼sudo amazon-linux-extras install dockersudo service docker start</code></pre><p>ç”±äºdockeré•œåƒæºé»˜è®¤æ˜¯åœ¨å›½å¤–ï¼Œæ‹‰å–é•œåƒé€Ÿåº¦éå¸¸æ…¢ï¼Œä¿®æ”¹daemoné…ç½®æ–‡ä»¶/etc/docker/daemon.jsonæ¥ä½¿ç”¨åŠ é€Ÿå™¨</p><pre><code class="shell">mkdir -p /etc/dockertouch /etc/docker/daemon.jsonvim /etc/docker/daemon.json{  &quot;registry-mirrors&quot;: [&quot;https://b3sst9pc.mirror.aliyuncs.com&quot;]}systemctl daemon-reloadsystemctl restart docker</code></pre><h3 id="docker-composeå®‰è£…"><a href="#docker-composeå®‰è£…" class="headerlink" title="docker-composeå®‰è£…"></a>docker-composeå®‰è£…</h3><p>Docker Composeæ˜¯ docker æä¾›çš„ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨æ¥å®šä¹‰å’Œè¿è¡Œç”±å¤šä¸ªå®¹å™¨ç»„æˆçš„åº”ç”¨ã€‚ä½¿ç”¨ composeï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ YAML æ–‡ä»¶å£°æ˜å¼çš„å®šä¹‰åº”ç”¨ç¨‹åºçš„å„ä¸ªæœåŠ¡ï¼Œå¹¶ç”±å•ä¸ªå‘½ä»¤å®Œæˆåº”ç”¨çš„åˆ›å»ºå’Œå¯åŠ¨ã€‚</p><ul><li><p>docker-composeå‘½ä»¤å®‰è£…</p><pre><code class="shell"># å®‰è£…pipyum -y install epel-releaseyum -y install python-pip# ç¡®è®¤ç‰ˆæœ¬pip --version# æ›´æ–°pippip install --upgrade pip# å®‰è£…docker-composepip install docker-compose # æŸ¥çœ‹ç‰ˆæœ¬docker-compose version</code></pre></li></ul><h2 id="nextcloudçš„éƒ¨ç½²"><a href="#nextcloudçš„éƒ¨ç½²" class="headerlink" title="nextcloudçš„éƒ¨ç½²"></a>nextcloudçš„éƒ¨ç½²</h2><p>nextcloudé€šè¿‡docker-composeå‘½ä»¤è¿›è¡Œæ„å»ºï¼Œåˆ›å»º docker-compose.ymlæ–‡ä»¶</p><pre><code class="shell"># åˆ›å»ºdocker-compose.ymlæ–‡ä»¶touch docker-compose.yml# ç²˜è´´ä»¥ä¸‹å†…å®¹version: &#39;2&#39;services:  db:    image: mariadb    restart: always    volumes:      - /data/mariadb:/var/lib/mysql    environment:      - MYSQL_ROOT_PASSWORD=root      - MYSQL_PASSWORD=nextcloud      - MYSQL_DATABASE=nextcloud      - MYSQL_USER=nextcloud  app:    image: nextcloud    restart: always    ports:      - 8091:80    links:      - db    volumes:      - /data/nextcloud/data:/var/www/html/data          - /data/nextcloud/themes:/var/www/html/themes      - /data/nextcloud/apps:/var/www/html/custom_apps</code></pre><p>docker-compose.ymlæ–‡ä»¶è¯´æ˜</p><p>é€šè¿‡å¯åŠ¨ä¸¤ä¸ªserviceæœåŠ¡mariadbåŠnextcloudæœåŠ¡ï¼Œå¹¶é€šè¿‡linkè¿æ¥åˆ°ä¸€èµ·ï¼Œå…¶ä¸­å°†/var/www/html/dataã€/var/www/html/themesã€/var/www/html/custom_appsæ˜ å°„åˆ°linuxæœåŠ¡å™¨æŒ‡å®šç›®å½•å®ç°æ•°æ®æŒä¹…åŒ–ï¼Œè¿™æ ·ä¸‹æ¬¡dockeré‡å¯çš„æ—¶å€™æ•°æ®ä¸ä¼šå‘ç”Ÿä¸¢å¤±ã€‚</p><p>nextcloudå®ç°é¢„è§ˆç¼–è¾‘officeæ–‡ä»¶éœ€è¦æ’ä»¶onlyofficeæ”¯æŒï¼Œé€šè¿‡dockeråˆ›å»ºonlyofficeæœåŠ¡å™¨ï¼Œå¹¶å¯åŠ¨nextcloudé…ç½®onlyoffice</p><pre><code class="shell">docker run -it -d -p 8061:80 onlyoffice/documentserver  -v /data/onlyoffice/logs:/var/log/onlyoffice /data/onlyoffice/data:/var/www/onlyoffice/Data /data/onlyoffice/lib:/var/lib/onlyoffice /data/onlyoffice/db:/var/lib/postgresql</code></pre><p>å¯åŠ¨nextcloudã€åœæ­¢nextcloudã€æŸ¥çœ‹nextcloudå¯åŠ¨çŠ¶æ€</p><pre><code class="shell"># å¯åŠ¨nextclouddocker-compose up -d# æŸ¥çœ‹nextcloudçŠ¶æ€docker-compose ps# åœæ­¢nextclouddocker-compose stop</code></pre><h2 id="nextcloudçš„æ•°æ®è¿ç§»"><a href="#nextcloudçš„æ•°æ®è¿ç§»" class="headerlink" title="nextcloudçš„æ•°æ®è¿ç§»"></a>nextcloudçš„æ•°æ®è¿ç§»</h2><p>å½“éœ€è¦nextcloudè¿ç§»åˆ°å¦å¤–ä¸€å°æœåŠ¡çš„æ—¶å€™ï¼Œéœ€è¦å°†nextcloudæŒä¹…åŒ–çš„æ•°æ®é€šè¿‡scpæˆ–è€…å…¶ä»–æ–¹å¼å¤åˆ¶åˆ°å¦å¤–ä¸€å°æœºå™¨ï¼Œå°†åŸæ¥çš„æœºå™¨mariadbçš„nextcloudæ•°æ®åº“è¿›è¡Œå¯¼å‡ºï¼Œåœ¨æ–°çš„æœºå™¨ä¸Šé¢å¯¼å…¥æ•°æ®åº“æ•°æ®ã€‚å¤åˆ¶YAMLæ–‡ä»¶åˆ°æ–°çš„æœºå™¨ï¼Œé€šè¿‡docker-composeè¿›è¡Œå¯åŠ¨ï¼Œè¿›å…¥å®¹å™¨å†…éƒ¨ä¿®æ”¹æŒä¹…åŒ–æ•°æ®çš„æƒé™åŠä¿®æ”¹nextcloudé…ç½®æ–‡ä»¶ï¼Œæœ€åé‡å¯å®¹å™¨ã€‚</p><pre><code class="shell"># å¤åˆ¶æŒä¹…åŒ–æ•°æ®åˆ°æ–°çš„æœºå™¨ä¸Šé¢scp -R /data/nextcloud root@192.168.12.1:/data# å¯¼å‡ºåŸæ¥æœºå™¨çš„ä¸Šé¢çš„mariadbæ•°æ®docker exec -it  nextcloud_db_1ã€dockerå®¹å™¨åç§°/IDã€‘ mysqldump -uroot -prootã€æ•°æ®åº“å¯†ç ã€‘ nextcloudã€æ•°æ®åº“åç§°ã€‘ &gt; /opt/sql_bak/nextcloud.sqlã€å¯¼å‡ºè¡¨æ ¼è·¯å¾„ã€‘# å°†sqlæ–‡ä»¶å¤åˆ¶åˆ°æ–°çš„æœºå™¨ä¸Šé¢scp  /opt/sql_bak/nextcloud.sql root@192.168.12.1:/opt/sql_bak# åœ¨æ–°çš„æœºå™¨ä¸Šé¢æ‰§è¡Œè¯¥sqlæ–‡ä»¶(éœ€è¦å…ˆå¯åŠ¨dockerå®¹å™¨)docker cp /opt/sql_bak/nextcloud.sql ã€å®¹å™¨åã€‘:/root/docker exec -it ã€å®¹å™¨å/IDã€‘shmysql -uroot -p nextcloudã€æ•°æ®åº“åã€‘ &lt; /root/nextcloud.sql# é€šè¿‡docker-composeå¯åŠ¨é•œåƒï¼Œä¿®æ”¹æƒé™ docker exec -it -u root nextcloud_app_1ã€å®¹å™¨id/å®¹å™¨åã€‘ /bin/bash root@bafc02ce112a:/var/www/html# chown -R www-data:root /var/www/html/ root@bafc02ce112a:exit# ä¿®æ”¹nextcloudé…ç½®æ–‡ä»¶vim /data/nextcloud/config/config.php# ä¿®æ”¹ip&#39;trusted_domains&#39; =&gt;  array (    0 =&gt; &#39;161.189.27.8:8091&#39;,  ),  &#39;datadirectory&#39; =&gt; &#39;/var/www/html/data&#39;,  &#39;dbtype&#39; =&gt; &#39;mysql&#39;,  &#39;version&#39; =&gt; &#39;16.0.4.1&#39;,  &#39;overwrite.cli.url&#39; =&gt; &#39;http://161.189.27.8:8091&#39;,# é‡å¯docker-compose restart</code></pre><h2 id="trouble-shooting"><a href="#trouble-shooting" class="headerlink" title="trouble shooting"></a>trouble shooting</h2><ul><li><p>å®‰è£…docker-composeå‘½ä»¤æ‰§è¡Œpip install docker-composeçš„æ—¶å€™æŠ¥ä»¥ä¸‹é”™è¯¯</p><pre><code>ERROR: Cannot uninstall &#39;requests&#39;. It is a distutils installed project and thus we cannot accurately determine which files belong to it which would lead to only a partial uninstall.</code></pre><p>è§£å†³ç‰ˆæœ¬ï¼Œå¼ºåˆ¶å®‰è£…requestsåŒ…</p><pre><code class="shell"> pip install --ignore-installed requests</code></pre><p>å†é‡æ–°æ‰§è¡Œ</p><pre><code class="shell">pip install docker-compose</code></pre></li><li><p>docker-composeæŠ¥é”™ï¼šNo module named ssl_match_hostname</p><pre><code>File &quot;/usr/local/lib/python2.7/dist-packages/docker/transport/ssladapter.py&quot;, line 23, in &lt;module&gt;from backports.ssl_match_hostname import match_hostnameImportError: No module named ssl_match_hostname</code></pre><p>åŸå› ï¼š</p><p><strong>/usr/local/lib/python2.7/distpackages/docker/transport/ssladapter.py **<br>åœ¨åŒ…è·¯å¾„ä¸‹æ‰¾ä¸åˆ° **backportsåŒ…é‡Œçš„ssl_match_hostname</strong>æ¨¡å—</p><p>è§£å†³åŠæ³•</p><pre><code class="shell">#è¿›å…¥backportsæ¨¡å—è·¯å¾„cd /usr/lib/python2.7/site-packages#å¤åˆ¶æ•´ä¸ªåŒ…åˆ°transportåŒ…è·¯å¾„ä¸‹cp -r backports /usr/lib/python2.7/site-packages/docker/transport</code></pre></li></ul>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>nextcloud</tag>
      
      <tag>ç½‘ç›˜</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Harboréƒ¨ç½²</title>
    <link href="/2020/01/09/Harbor%E9%83%A8%E7%BD%B2/"/>
    <url>/2020/01/09/Harbor%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="harboræ­å»º"><a href="#harboræ­å»º" class="headerlink" title="harboræ­å»º"></a>harboræ­å»º</h2><p>å®˜æ–¹æä¾›ä¸¤ç§æ–¹å¼å®‰è£…harborï¼Œç¦»çº¿åŠåœ¨çº¿æ–¹å¼ã€‚æœ¬æ–‡æ¡£æè¿°ç¦»çº¿æ–¹å¼è¿›è¡Œå®‰è£…</p><p>æŸ¥çœ‹docker-composeç‰ˆæœ¬ï¼Œè‹¥ç‰ˆæœ¬ä½è¿›è¡Œå‡çº§å®‰è£…ï¼Œ</p><p>ä¸‹è½½å®˜æ–¹å®‰è£…åŒ…</p><pre><code class="shell">cd /optwget https://storage.googleapis.com/harbor-releases/release-1.9.0/harbor-offline-installer-v1.9.2-rc1.tgz# è§£å‹tar zxvf harbor-offline-installer-v1.9.2-rc1.tgz# æŸ¥çœ‹cd harborls[root@ip-172-31-23-16 harbor]# lltotal 623296drwxr-xr-x 3 root root        20 Nov  5 05:50 common-rw-r--r-- 1 root root      5369 Nov  5 06:07 docker-compose.yml-rw-r--r-- 1 root root 638214056 Nov  1 03:14 harbor.v1.9.2.tar.gz-rw-r--r-- 1 root root      5816 Nov  5 06:07 harbor.yml-rwxr-xr-x 1 root root      5088 Nov  1 03:13 install.sh-rw-r--r-- 1 root root     11347 Nov  1 03:13 LICENSE-rwxr-xr-x 1 root root      1748 Nov  1 03:13 prepare</code></pre><p>ä¿®æ”¹é…ç½®ï¼Œä¸»è¦ä¿®æ”¹ä¸¤ä¸ªæ–‡ä»¶</p><p>harbor.ymlä¸ºç³»ç»Ÿé…ç½®æ–‡ä»¶ï¼Œdocker-compose.ymlä¸ºdockerç›¸å…³é…ç½®æ–‡ä»¶</p><p>ä¿®æ”¹harbor.yml</p><pre><code class="shell">vim harbor.yml# ä¿®æ”¹hostnamehostname: 52.83.79.244# ä¿®æ”¹æ˜ å°„ç«¯å£http:  port: 8093# ä¿®æ”¹admin passwordï¼ˆå¯é€‰ï¼‰harbor_admin_password: 1qaz!QAZ# ä¿®æ”¹æ•°æ®åº“ç›¸å…³å‚æ•°database:  password: root  max_idle_conns: 50  max_open_conns: 100# ä¿®æ”¹æ•°æ®æŒä¹…åŒ–hostç›®å½•data_volume: /data/harbor# ä¿®æ”¹logç›®å½• location: /var/log/harbor</code></pre><p>ä¿®æ”¹docker-compose.ymlæ–‡ä»¶</p><pre><code class="yaml">vim docker-compose.yml# æ·»åŠ portsæ˜ å°„registry:    image: goharbor/registry-photon:v2.7.1-patch-2819-2553-v1.9.2    container_name: registry    restart: always    ports:      - 5000:5000</code></pre><p>å¯åŠ¨harbor</p><pre><code>./install.sh</code></pre><p>å®‰è£…ä¹‹åæŸ¥çœ‹</p><pre><code class="shell">docker-compose ps     Name                     Command                  State                 Ports---------------------------------------------------------------------------------------------harbor-core         /harbor/harbor_core              Up (healthy)harbor-db           /docker-entrypoint.sh            Up (healthy)   5432/tcpharbor-jobservice   /harbor/harbor_jobservice  ...   Up (healthy)harbor-log          /bin/sh -c /usr/local/bin/ ...   Up (healthy)   127.0.0.1:1514-&gt;10514/tcpharbor-portal       nginx -g daemon off;             Up (healthy)   8080/tcpnginx               nginx -g daemon off;             Up (healthy)   0.0.0.0:8093-&gt;8080/tcpredis               redis-server /etc/redis.conf     Up (healthy)   6379/tcpregistry            /entrypoint.sh /etc/regist ...   Restartingregistryctl         /harbor/start.sh                 Up (healthy)</code></pre><p>ç™»å½•harbor ï¼Œè´¦å·å¯†ç ä¸ºharbor.ymlæ‰€è®¾ç½®çš„å¯†ç </p><p><a href="http://52.83.79.244:8093/harbor/projects" target="_blank" rel="noopener">http://52.83.79.244:8093/harbor/projects</a></p><p>ç™»å½•æ—¶å€™è¿˜ä¸èƒ½ç›´æ¥åˆ©ç”¨docker push åˆ°æœåŠ¡å™¨ï¼Œè¿™æ˜¯å› ä¸º docker1.3.2 ç‰ˆæœ¬å¼€å§‹é»˜è®¤ docker registry ä½¿ç”¨çš„æ˜¯ httpsï¼Œæˆ‘ä»¬è®¾ç½® Harbor é»˜è®¤ http æ–¹å¼ï¼Œæ‰€ä»¥å½“æ‰§è¡Œç”¨ docker loginã€pullã€push ç­‰å‘½ä»¤æ“ä½œé https çš„ docker regsitry çš„æ—¶å°±ä¼šæŠ¥é”™ã€‚è§£å†³åŠæ³•ï¼š</p><pre><code class="shell">vim /usr/lib/systemd/system/docker.service# ExecStart å¢åŠ  --insecure-registry=52.83.79.244ã€é…ç½®æ–‡ä»¶ä¸­çš„hostnameã€‘ExecStart=/usr/bin/dockerd $OPTIONS $DOCKER_STORAGE_OPTIONS $DOCKER_ADD_RUNTIMES --insecure-registry=52.83.79.244:8093# é‡å¯æœåŠ¡systemctl daemon-reloadsystemctl restart docker</code></pre><p>harborå¸¸ç”¨å‘½ä»¤</p><pre><code class="shell"># éœ€è¦è¿›å…¥harboræ–‡ä»¶å¤¹æ‰§è¡Œcd /opt/harbordocker-compose up -d               ###åå°å¯åŠ¨ï¼Œå¦‚æœå®¹å™¨ä¸å­˜åœ¨æ ¹æ®é•œåƒè‡ªåŠ¨åˆ›å»ºdocker-compose down   -v           ###åœæ­¢å®¹å™¨å¹¶åˆ é™¤å®¹å™¨docker-compose start               ###å¯åŠ¨å®¹å™¨ï¼Œå®¹å™¨ä¸å­˜åœ¨å°±æ— æ³•å¯åŠ¨ï¼Œä¸ä¼šè‡ªåŠ¨åˆ›å»ºé•œåƒdocker-compose stop                ###åœæ­¢å®¹å™¨</code></pre><h2 id="ä½¿ç”¨åŠé…ç½®"><a href="#ä½¿ç”¨åŠé…ç½®" class="headerlink" title="ä½¿ç”¨åŠé…ç½®"></a>ä½¿ç”¨åŠé…ç½®</h2><ul><li><p>docker ç™»å½•åˆ°harbor</p><pre><code class="shell">[root@ip-172-31-23-16 harbor]# docker login 52.83.79.244:8093Username: adminPassword:WARNING! Your password will be stored unencrypted in /root/.docker/config.json.Configure a credential helper to remove this warning. Seehttps://docs.docker.com/engine/reference/commandline/login/#credentials-storeLogin Succeeded</code></pre></li></ul><p>ç™»å½•harborååˆ›å»ºä¸€ä¸ªå…¬å…±ä»“åº“ï¼Œå‘½åä¸ºwuhan</p><p>å°†é•œåƒå‘å¸ƒåˆ°harbor</p><pre><code class="shell"># æŸ¥çœ‹éœ€è¦ä¸Šä¼ çš„é•œåƒdocker images# ä¸ºé•œåƒä¸Štagdocker tag jenkins/jenkins:lts 52.83.79.244:8093/wuhan/jenkins:lts# ä¸Šä¼ åˆ°wuhanåº“docker push jenkins/jenkins:lts 52.83.79.244:8093/wuhan/jenkins:lts# è‹¥éœ€è¦ä¸Šä¼ åˆ°libraryåº“docker push jenkins/jenkins:lts 52.83.79.244:8093/library/jenkins:lts</code></pre><h2 id="é…ç½®httpsåè®®"><a href="#é…ç½®httpsåè®®" class="headerlink" title="é…ç½®httpsåè®®"></a>é…ç½®httpsåè®®</h2><pre><code class="shell"># å‡†å¤‡å·¥ä½œmkdir -p /data/harbor-certyum install -y openssl------------cd data/harbor-certopenssl genrsa -des3 -out server.key 2048 openssl req -new -key server.key -out server.csr cp server.key server.key.org openssl rsa -in server.key.org -out server.key openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt </code></pre><p>ç”Ÿæˆè¯ä¹¦ä¹‹åï¼Œä¿®æ”¹harbor.yamlæ–‡ä»¶<br>å…·ä½“é…ç½®å¦‚ä¸‹<br><a href="http://52.83.79.244:6875/uploads/images/gallery/2019-12-Dec/WX20191219-155232@2x.png" target="_blank" rel="noopener"><img src="http://52.83.79.244:6875/uploads/images/gallery/2019-12-Dec/scaled-840-0/WX20191219-155232@2x.png" srcset="/img/loading.gif" alt="WX20191219-155232@2x.png"></a></p>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
    </categories>
    
    
    <tags>
      
      <tag>https</tag>
      
      <tag>è¯ä¹¦</tag>
      
      <tag>harbor</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>K8sç›‘æ§éƒ¨ç½²æ–¹æ¡ˆ</title>
    <link href="/2020/01/07/K8s%E7%9B%91%E6%8E%A7%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88/"/>
    <url>/2020/01/07/K8s%E7%9B%91%E6%8E%A7%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88/</url>
    
    <content type="html"><![CDATA[<h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><p><img src="https://i.loli.net/2020/01/08/DVBiRAwaNsnYbgL.png" srcset="/img/loading.gif" alt="grafana"></p><h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p><strong>yamlæ–‡ä»¶åœ°å€ ğŸ‘‰ğŸ»   <a href="https://161.189.27.8:8090/dqdev/pythogoras/tree/master/k8s-yaml/prometheus" target="_blank" rel="noopener">pythagoras</a></strong></p><h3 id="1-åœ¨k8sé›†ç¾¤ä¸­åˆ›å»ºnamespace"><a href="#1-åœ¨k8sé›†ç¾¤ä¸­åˆ›å»ºnamespace" class="headerlink" title="1 åœ¨k8sé›†ç¾¤ä¸­åˆ›å»ºnamespace"></a>1 åœ¨k8sé›†ç¾¤ä¸­åˆ›å»ºnamespace</h3><pre><code class="yaml">apiVersion: v1kind: Namespacemetadata:   name: ns-monitor  labels:    name: ns-monitorkubectl apply -f namespace.yaml</code></pre><h3 id="2-å®‰è£…node-exporter"><a href="#2-å®‰è£…node-exporter" class="headerlink" title="2 å®‰è£…node-exporter"></a>2 å®‰è£…node-exporter</h3><p>åœ¨kubernetesté›†ç¾¤ä¸­éƒ¨ç½²node-exporterï¼ŒNode-exporterç”¨äºé‡‡é›†kubernetesé›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹çš„ç‰©ç†æŒ‡æ ‡ï¼Œæ¯”å¦‚ï¼šMemoryã€CPUç­‰ã€‚å¯ä»¥ç›´æ¥åœ¨æ¯ä¸ªç‰©ç†èŠ‚ç‚¹æ˜¯ç›´æ¥å®‰è£…ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨DaemonSetéƒ¨ç½²åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä½¿ç”¨ hostNetwork: true å’Œ hostPID: true ä½¿å…¶è·å¾—Nodeçš„ç‰©ç†æŒ‡æ ‡ä¿¡æ¯ï¼Œé…ç½®tolerationsä½¿å…¶åœ¨masterèŠ‚ç‚¹ä¹Ÿå¯åŠ¨ä¸€ä¸ªpodã€‚</p><p>node-exporter.yaml</p><pre><code class="yaml">kind: DaemonSetapiVersion: apps/v1beta2metadata:   labels:    app: node-exporter  name: node-exporter  namespace: ns-monitorspec:  revisionHistoryLimit: 10  selector:    matchLabels:      app: node-exporter  template:    metadata:      labels:        app: node-exporter    spec:      containers:        - name: node-exporter          image: prom/node-exporter:v0.16.0          ports:            - containerPort: 9100              protocol: TCP              name:    http      hostNetwork: true      hostPID: true      tolerations:        - effect: NoSchedule          operator: Exists---kind: ServiceapiVersion: v1metadata:  labels:    app: node-exporter  name: node-exporter-service  namespace: ns-monitorspec:  ports:    - name:    http      port: 9100      nodePort: 31672      protocol: TCP  type: NodePort  selector:    app: node-exporter</code></pre><pre><code class="shell">kubectl apply -f node-exporter.yaml</code></pre><p><strong>*æ£€æŸ¥æ˜¯å¦æ‰§è¡ŒæˆåŠŸ(å¯¹åº”podåŠsvc)</strong> ğŸ‘‰ğŸ» **</p><pre><code class="shell">âœ  ~ kubectl get pod -n ns-monitorNAME                          READY   STATUS    RESTARTS   AGEgrafana-547699f75-lxljq       1/1     Running   0          3h37mnode-exporter-75nmc           0/1     Pending   0          20hnode-exporter-t29kx           1/1     Running   0          20hnode-exporter-z6s7x           1/1     Running   0          20hprometheus-7d7654554d-f5fvf   1/1     Running   0          3h45mâœ  ~ kubectl get svc -n ns-monitorNAME                    TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGEgrafana-service         NodePort   10.1.242.56    &lt;none&gt;        3000:31026/TCP   3h38mnode-exporter-service   NodePort   10.1.130.7     &lt;none&gt;        9100:31672/TCP   20hprometheus-service      NodePort   10.1.133.130   &lt;none&gt;        9090:30753/TCP   3h45m</code></pre><p><img src="https://i.loli.net/2020/01/08/TP6tIlvFKhgzHuZ.png" srcset="/img/loading.gif" alt="image-20200103143320329"></p><h3 id="3-éƒ¨ç½²Prometheus-pod"><a href="#3-éƒ¨ç½²Prometheus-pod" class="headerlink" title="3 éƒ¨ç½²Prometheus pod"></a>3 éƒ¨ç½²Prometheus pod</h3><p>prometheus.yaml ä¸­åŒ…å«rbacè®¤è¯ã€ConfigMapç­‰</p><pre><code class="shell">kubectl apply -f prometheus.yaml </code></pre><p><em>æ£€æŸ¥æ˜¯å¦æ‰§è¡ŒæˆåŠŸ(å¯¹åº”podåŠsvc)*</em> ğŸ‘‰ğŸ» </p><pre><code class="shell">âœ  ~ kubectl get pod -n ns-monitorNAME                          READY   STATUS    RESTARTS   AGEgrafana-547699f75-lxljq       1/1     Running   0          3h37mnode-exporter-75nmc           0/1     Pending   0          20hnode-exporter-t29kx           1/1     Running   0          20hnode-exporter-z6s7x           1/1     Running   0          20hprometheus-7d7654554d-f5fvf   1/1     Running   0          3h45mâœ  ~ kubectl get svc -n ns-monitorNAME                    TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGEgrafana-service         NodePort   10.1.242.56    &lt;none&gt;        3000:31026/TCP   3h38mnode-exporter-service   NodePort   10.1.130.7     &lt;none&gt;        9100:31672/TCP   20hprometheus-service      NodePort   10.1.133.130   &lt;none&gt;        9090:30753/TCP   3h45m</code></pre><p><img src="https://i.loli.net/2020/01/08/fdFs8EN2xhHwCM6.png" srcset="/img/loading.gif" alt="image-20200103143645494"></p><h3 id="4-åœ¨k8sä¸­éƒ¨ç½²grafana"><a href="#4-åœ¨k8sä¸­éƒ¨ç½²grafana" class="headerlink" title="4 åœ¨k8sä¸­éƒ¨ç½²grafana"></a>4 åœ¨k8sä¸­éƒ¨ç½²grafana</h3><pre><code class="shell">kubectl apply -f grafana.yaml</code></pre><p><strong>æ£€æŸ¥æ˜¯å¦æ‰§è¡ŒæˆåŠŸ(å¯¹åº”podåŠsvc)</strong> ğŸ‘‰ğŸ» </p><pre><code class="shell">âœ  ~ kubectl get pod -n ns-monitorNAME                          READY   STATUS    RESTARTS   AGEgrafana-547699f75-lxljq       1/1     Running   0          3h37mnode-exporter-75nmc           0/1     Pending   0          20hnode-exporter-t29kx           1/1     Running   0          20hnode-exporter-z6s7x           1/1     Running   0          20hprometheus-7d7654554d-f5fvf   1/1     Running   0          3h45mâœ  ~ kubectl get svc -n ns-monitorNAME                    TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGEgrafana-service         NodePort   10.1.242.56    &lt;none&gt;        3000:31026/TCP   3h38mnode-exporter-service   NodePort   10.1.130.7     &lt;none&gt;        9100:31672/TCP   20hprometheus-service      NodePort   10.1.133.130   &lt;none&gt;        9090:30753/TCP   3h45m</code></pre><h3 id="5-é…ç½®grafanaæ•°æ®æº"><a href="#5-é…ç½®grafanaæ•°æ®æº" class="headerlink" title="5 é…ç½®grafanaæ•°æ®æº"></a>5 é…ç½®grafanaæ•°æ®æº</h3><p>æŠŠprometheusé…ç½®æˆæ•°æ®æº ï¼š<a href="http://prometheus-service.ns-monitor:9090" target="_blank" rel="noopener">http://prometheus-service.ns-monitor:9090</a></p><p><img src="https://i.loli.net/2020/01/08/fzxnrR5iguDjlHk.png" srcset="/img/loading.gif" alt="image-20200103144416930"></p><h3 id="6-å€’å…¥dashboard"><a href="#6-å€’å…¥dashboard" class="headerlink" title="6 å€’å…¥dashboard"></a>6 å€’å…¥dashboard</h3><p>æŠŠ kubernetesçš„Dashboardçš„æ¨¡æ¿å¯¼å…¥è¿›æ¥ï¼Œç›´æ¥æŠŠJSONæ ¼å¼å†…å®¹å¤åˆ¶è¿›æ¥ã€‚</p><p><img src="https://i.loli.net/2020/01/08/6XkA5hEjN1OWioS.png" srcset="/img/loading.gif" alt="image-20200103145516630"></p><h2 id="æ•ˆæœå›¾"><a href="#æ•ˆæœå›¾" class="headerlink" title="æ•ˆæœå›¾"></a>æ•ˆæœå›¾</h2><p><img src="https://i.loli.net/2020/01/08/bqEolIi8KVSGuHk.png" srcset="/img/loading.gif" alt="image-20200103145627198"></p><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ul><li><p><a href="https://jimmysong.io/kubernetes-handbook/practice/using-prometheus-to-monitor-kuberentes-cluster.html" target="_blank" rel="noopener">ä½¿ç”¨Prometheusç›‘æ§kubernetesé›†ç¾¤</a></p></li><li><p><a href="https://www.jianshu.com/p/ac8853927528" target="_blank" rel="noopener">k8så®‰è£…Prometheus+Grafana</a></p></li><li><p><a href="https://github.com/giantswarm/kubernetes-prometheus" target="_blank" rel="noopener">github-kubernetes-promethues</a></p></li><li><p><a href="https://github.com/giantswarm/prometheus" target="_blank" rel="noopener">github-giantswarm-promethues</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>kubernetes</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kubernetes</tag>
      
      <tag>grafana</tag>
      
      <tag>prometheus</tag>
      
      <tag>ç›‘æ§</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Gitlabå¼€å¯Https</title>
    <link href="/2020/01/07/gitlab%E5%BC%80%E5%90%AFhttps/"/>
    <url>/2020/01/07/gitlab%E5%BC%80%E5%90%AFhttps/</url>
    
    <content type="html"><![CDATA[<h2 id="Gitlabå¼€å¯Https"><a href="#Gitlabå¼€å¯Https" class="headerlink" title="Gitlabå¼€å¯Https"></a>Gitlabå¼€å¯Https</h2><h3 id="å»ºç«‹è®¤è¯ç›®å½•"><a href="#å»ºç«‹è®¤è¯ç›®å½•" class="headerlink" title="å»ºç«‹è®¤è¯ç›®å½•"></a>å»ºç«‹è®¤è¯ç›®å½•</h3><pre><code class="shell">mkdir -p /etc/gitlab/sslchmod 700 /etc/gitlab/ssl</code></pre><h3 id="å»ºç«‹è¯ä¹¦"><a href="#å»ºç«‹è¯ä¹¦" class="headerlink" title="å»ºç«‹è¯ä¹¦"></a>å»ºç«‹è¯ä¹¦</h3><pre><code class="shell"># step 1 åˆ›å»ºprivate key ï¼ˆè®°ä½è¾“å…¥çš„å¯†ç ï¼ˆPass phraseï¼‰ï¼‰openssl genrsa -des3 -out /etc/gitlab/ssl/server.key 2048# step 2 ç”Ÿæˆ Certificate Requestopenssl req -new -key /etc/gitlab/ssl/gitlab.domain.com.key -out /etc/gitlab/ssl/server.csr</code></pre><blockquote><p> Enter Country Name CN<br> Enter State or Province Full Name HB<br> Enter City Name WuHan<br> Enter Organization Name<br> Enter Company Name EV-IV<br> Enter Organizational Unit Name<br> Enter server hostname i.e. URL gitlab.domain.com<br> Enter Admin Email Address<br> Skip Challenge Password (Hit Enter)<br> Skip Optional Company Name (Hit Enter)</p></blockquote><pre><code class="shell">#åœ¨åŠ è½½SSLæ”¯æŒçš„Nginxå¹¶ä½¿ç”¨ä¸Šè¿°ç§é’¥æ—¶è¦é™¤å»åˆšæ‰è®¾ç½®çš„å£ä»¤ï¼š #step3 å¤‡ä»½csræ–‡ä»¶åŠå»é™¤å‘½ä»¤ï¼Œç›´æ¥è¦†ç›–äº†server.keyäº†openssl rsa -inserver.key.org -out server.key#step 4æœ€åæ ‡è®°è¯ä¹¦ä½¿ç”¨ä¸Šè¿°ç§é’¥å’ŒCSRï¼šï¼ˆæŠŠcsræ ‡è®°åè½¬æ¢æˆäº†crt nginxè¦ç”¨keyå’Œcrtæ–‡ä»¶ï¼‰openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt</code></pre><h3 id="ä¿®æ”¹gitlabé…ç½®"><a href="#ä¿®æ”¹gitlabé…ç½®" class="headerlink" title="ä¿®æ”¹gitlabé…ç½®"></a>ä¿®æ”¹gitlabé…ç½®</h3><pre><code class="shell">vim /etc/gitlab/gitlab.rbexternal_url &#39;https://161.189.27.8:8090/&#39;nginx[&#39;redirect_http_to_https&#39;]= truenginx[&#39;ssl_client_certificate&#39;] = &quot;/etc/gitlab/ssl/server.crt&quot;nginx[&#39;ssl_certificate&#39;]= &quot;/etc/gitlab/ssl/server.crt&quot;nginx[&#39;ssl_certificate_key&#39;]= &quot;/etc/gitlab/ssl/server.key&quot;</code></pre><h3 id="é‡å¯gitlab"><a href="#é‡å¯gitlab" class="headerlink" title="é‡å¯gitlab"></a>é‡å¯gitlab</h3><pre><code class="shell">gitlab-ctl reconfiguregitlab-ctl restart</code></pre><p>æœ€åé€šè¿‡è®¿é—®httpsåœ°å€è¿›è¡Œè®¿é—®æµ‹è¯•</p><h3 id="ç›¸å…³é—®é¢˜"><a href="#ç›¸å…³é—®é¢˜" class="headerlink" title="ç›¸å…³é—®é¢˜"></a>ç›¸å…³é—®é¢˜</h3><p>Q1 ç”±äºsslè¯ä¹¦ä¸ºè‡ªç­¾è¯ä¹¦ git cloneæŠ¥é”™</p><pre><code class="shell">git clone https://161.189.27.8:8090/dqdev/pythogoras.gitCloning into &#39;pythogoras&#39;...fatal: unable to access &#39;https://161.189.27.8:8090/dqdev/pythogoras.git/&#39;: SSL certificate problem: self signed certificate</code></pre><p>å…³é—­git ssléªŒè¯</p><pre><code class="bash">git config --global http.sslVerify false å…³é—­git config --global http.sslVerify true  å¼€å¯</code></pre>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
    </categories>
    
    
    <tags>
      
      <tag>gitlab</tag>
      
      <tag>ssl</tag>
      
      <tag>https</tag>
      
      <tag>è¯ä¹¦</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
